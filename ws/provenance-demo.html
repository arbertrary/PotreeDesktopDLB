<html>

<head>
	<!-- <script src="recursive-diff.js"></script> From https://github.com/cosmicanant/recursive-diff/tree/master/dist -->
	<style>
		body {
			font-family: sans-serif;
		}

		.block {
			display: inline-block;
		}

		.group {
			border: 1px solid #ccc;
			border-radius: 0.3em;
			padding: 3px;
		}

		pre {
			font-family: 'Courier New', Courier, monospace;
			background-color: #ccc;
		}

		pre.changes {
			background-color: white;
		}
	</style>
</head>

<body>
	<b>Connection</b><br />
	<span class="block group">
		<input type="text" id="scenename" style="width: 15em;" value="ws://localhost:8080/sync/default">
		<button onclick="connect()">Connect</button>
		<button onclick="sendSceneMessage()">Send Scene</button>
	</span>
	<hr />
	<b>Log</b><br />
	<pre id="log" style="height: 10em; overflow-y: scroll;" class="block group"></pre>
	<hr>
	<b>Events</b>
	<div id="events" style="display: flex; flex-direction: column;">
	</div>
	<script>
		//Storage for the current scene
		let currentScene = null;

		//Logging
		let logel = document.getElementById("log");
		function log(msg) {
			logel.innerText = new Date().toUTCString() + " " + msg + "\n" + logel.innerText;
		}

		//Delay helper
		async function delay(ms) {
			return new Promise((res, rej) => {
				setTimeout(res, ms);
			});
		}

		//Websocket and connection
		let ws = null;
		async function connect() {
			try {
				// let url = "ws://10.136.99.192:3030";
				let url = "ws://localhost:3030";

				log("Attempting connection")
				ws = new WebSocket(url);
				ws.addEventListener("message", received);
				while (ws.readyState != ws.OPEN) {
					await delay(250);
				}
				log("Connected");
				// sendGetSceneMessage();
				// setInterval(sendSceneMessage, 10000);
				setInterval(sendGetSceneMessage, 10000);
			}
			catch (e) {
				log("Error connecting: " + e.message);
			}
		}

		const potree_json = {
			type: "Potree",
			version: 1.7,
			settings: {
				pointBudget: 3000000,
				fov: 70,
				edlEnabled: true,
				edlRadius: 1.42,
				edlStrength: 0.4,
				background: 'gradient',
				minNodeSize: 0,
				showBoundingBoxes: false,
			},
			view: {
				position: [
					223343.55973855057,
					8321719.425141091,
					-1123.445818117769,
				],
				target: [
					223345.8973454748,
					8321724.689741484,
					-1127.0024343666873,
				],
			},
			classification: {
				'0': {
					visible: true,
					name: 'never classified',
					color: [
						0.5,
						0.5,
						0.5,
						1,
					],
				},
				'1': {
					visible: true,
					name: 'unclassified',
					color: [
						0.5,
						0.5,
						0.5,
						1,
					],
				},
				'2': {
					visible: true,
					name: 'ground',
					color: [
						0.63,
						0.32,
						0.18,
						1,
					],
				},
				'3': {
					visible: true,
					name: 'low vegetation',
					color: [
						0,
						1,
						0,
						1,
					],
				},
				'4': {
					visible: true,
					name: 'medium vegetation',
					color: [
						0,
						0.8,
						0,
						1,
					],
				},
				'5': {
					visible: true,
					name: 'high vegetation',
					color: [
						0,
						0.6,
						0,
						1,
					],
				},
				'6': {
					visible: true,
					name: 'building',
					color: [
						1,
						0.66,
						0,
						1,
					],
				},
				'7': {
					visible: true,
					name: 'low point(noise)',
					color: [
						1,
						0,
						1,
						1,
					],
				},
				'8': {
					visible: true,
					name: 'key-point',
					color: [
						1,
						0,
						0,
						1,
					],
				},
				'9': {
					visible: true,
					name: 'water',
					color: [
						0,
						0,
						1,
						1,
					],
				},
				'12': {
					visible: true,
					name: 'overlap',
					color: [
						1,
						1,
						0,
						1,
					],
				},
				DEFAULT: {
					visible: true,
					name: 'default',
					color: [
						0.3,
						0.6,
						0.6,
						0.5,
					],
				},
			},
			pointclouds: [
				{
					name: 'CentralGroup_testalignment_converted',
					url: 'C:\\Users\\abernstetter\\Desktop\\digital-earth-viewer-test/CentralGroup_testalignment_converted/metadata.json',
					position: [
						223260.7439,
						8321704.1465,
						-1204.0028,
					],
					rotation: [
						0,
						0,
						0,
						'XYZ',
					],
					scale: [
						1,
						1,
						1,
					],
					material: {
						activeAttributeName: 'rgba',
						ranges: [
							{
								name: 'elevationRange',
								value: [
									-1204.0028,
									-1117.222,
								],
							},
							{
								name: 'intensityRange',
								value: [
									514,
									65535,
								],
							},
						],
						size: 1,
						minSize: 2,
						pointSizeType: 'ADAPTIVE',
						matcap: 'matcap.jpg',
					},
				},
			],
			measurements: [
				{
					uuid: '3B8A52C6-9169-43A8-AAD6-DC5B9B0E4CBD',
					name: 'Height',
					points: [
						[
							223362.72780036775,
							8321776.007199862,
							-1162.192699802397,
						],
						[
							223389.1718998535,
							8321743.486399897,
							-1158.5516003494247,
						],
					],
					showDistances: false,
					showCoordinates: false,
					showArea: false,
					closed: false,
					showAngles: false,
					showHeight: true,
					showCircle: false,
					showAzimuth: false,
					showEdges: true,
					color: [
						1,
						0,
						0,
					],
				},
			],
			volumes: [],
			cameraAnimations: [],
			profiles: [],
			annotations: [],
			orientedImages: [],
			geopackages: [],
		}



		function sendSceneMessage() {
			msg = {
				type: "Scene",
				data: potree_json
			}
			ws.send(JSON.stringify(msg));
			// ws.send(JSON.stringify(potree_json));

		}

		function sendGetSceneMessage() {
			msg = {
				type: "GetScene"
			}
			ws.send(JSON.stringify(msg));

		}

		function received(e) {
			// let message = JSON.parse(e);
			console.log(e);
			log(e);


		}
            // function received(e){
            //     let message = JSON.parse(e.data);
            //     if(message.type == "Scene"){
            //         console.log(message.data);
            //         log("Received Scene State");
            //         if(currentScene == null){
            //             currentScene = message.data.scene;
            //         }else{
            //             console.log(message);
            //             let scene = message.data.scene;
            //             console.log(currentScene, scene);
            //             let diff = recursiveDiff.getDiff(currentScene, scene);
            //             currentScene = scene;
            //             if(diff.length == 0){
            //                 return;
            //             }
            //             let diffmessage = diff.map(d => {
            //                 let msg = d.op.toUpperCase() + " " + d.path.join(".");
            //                 if(d.val){
            //                     msg += " => " + JSON.stringify(d.val);
            //                 }
            //                 return msg;
            //             }).join("\n");
            //             let pre = document.createElement("pre");
            //             pre.classList.add("changes");
            //             pre.innerText = diffmessage;
            //             document.getElementById("events").appendChild(pre);
            //         }
            //         let button = document.createElement("button");
            //         button.innerText = new Date().toUTCString();
            //         button.onclick = () => {
            //             sendSceneMessage(message.data);
            //         };
            //         document.getElementById("events").appendChild(button);
            //     }
            // }
	</script>
</body>

</html>